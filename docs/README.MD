#HA服务介绍

------------

### HA业务介绍
- 负责CSP、IVS、融合数据等产品服务状态监控。
- 提供主备、Nway等HA类型的服务状态管理和仲裁。

![image.png](https://rnd-isourceb.huawei.com/images/XA/20190930/0cbbd455-846e-4375-8894-e5a853af648e/image.png)

*说明：分组产品服务状态由分组HAF管理。*

### HA与周边服务关系
- CSE: 负责**服务实例静态管理**，实现服务注册发现、订阅推送。
- SHA: 负责**服务实例动态管理**。实现有状态、无状态服务状态监控和倒换。
- GOV：**服务治理，可视化界面，故障上报、故障修复**。


### HA业务模型
基于HA业务，抽象出如下两个业务模型：
- 自仲裁业务模型
  该模型定义HA集群内不同HA实例的角色，不同角色承担不同的职责。
![image.png](https://rnd-isourceb.huawei.com/images/XA/20190930/62440500-5bf8-42e5-8a28-4700ebe0adfe/image.png)

角色说明：
1. **仲裁者集群**：多个HA服务实例组成一个仲裁者集群，集群对外提供统一的HA服务。
2. **仲裁者**：每个HA服务实例都拥有仲裁者角色，仲裁者对外提供HA服务。
3. **仲裁管理者**：每个仲裁者集群有且只有一个HA实例承担仲裁管理者角色，由仲裁管理者分配集群内每个仲裁者管理业务服务的范围。该角色对应的HA实例状态为Master。


- HA业务模型 
  该模型定义了HA支持的HA业务类型，以及服务实例、HA服务间的关系
![image.png](https://rnd-isourceb.huawei.com/images/XA/20190930/87009c6e-e8fb-4fef-8e08-48eeacc7c419/image.png)

角色说明：
1. **仲裁者**：负责管理服务组状态，CSP中SHA服务承担给角色。一个仲裁者对应管理多个服务组状态。
2. **服务组**：多个服务实例组成一个服务组，一个服务组对应CSE（服务中心）的一个服务,一个服务组内所有实例组成一个集群，对外提供同一种业务。因不同集群内冗余方式不相同，提供如下服务组类型：
- **服务组（主备）**（**已支持**）：服务组内有两个实例，一个实例是主状态，一个实例是备状态。仅主状态服务提供业务，在主实例故障后，备实例升主，继续提供业务处理。
- ** 服务组（负荷分担）**（**已支持**）：服务组内有两个及以上实例，所有实例都是主用状态，同时提供业务处理。任一实例故障，业务迁移至正常服务实例处理。
- **服务组（主从）**（不支持）：服务组内有两个及以上实例，仅主状态实例提供特定的业务处理（如写数据），其他实例是从状态，提供普通的业务处理（如读数据）。
- ** 服务组（资源组）**（不支持）：服务组内有两个实例，每个实例中有多个进程，协同一起，对外提供业务，资源组一般是主备的，仅主资源组对外提供业务。

### HA软件架构
基于HA业务模型，重新定义HA的软件架构。
#### 逻辑架构：定义HA服务与周边交互。

![image.png](https://rnd-isourceb.huawei.com/images/XA/20190930/db950ed9-8e0c-4f8e-abb5-eb04328458f6/image.png)

- SHA &harr; CSE:
 - SHA服务自发现：
	- SHA服务注册。
	- 查询/订阅 SHA实例。
	- 更新SHA状态。
 - 服务实例主动监控：
	- 实例故障后，主动去注册服务实例。
	- 查询/订阅管理的服务实例.

- SHA &harr; SHA:
- 分布式仲裁
	- 分布式选举消息（心跳、仲裁、监控）
- 数据同步
	- HA服务间数据同步（仲裁者同步）
	
SHA &harr; SHA_SDK:
- 上行（SHA_SDK &rarr; SHA）：
	- 申请仲裁者。
	- 上报心跳。
	- 主动倒换。
	- 禁止倒换。
- 下行（SHA_SDK &larr; SHA）：
	- 下发仲裁。
	- 心跳响应。

SHA_SDK &harr; SRV:
- 初始化：
	- 启动HA。
	- HA配置文件。
	- 注册状态变化回调。
- 运行时：
	- 主动倒换。
	- 禁止倒换。
	- 状态变化通知。

SHA_SDK &rarr; CSE:
- HA服务发现：
	- 查询/订阅SHA实例Ips。
- 本地状态同步：
	- 更新本实例HA状态。


SHA_SDK &rarr; GOV:
- 强制复位POD。


#### 物理架构：定义HA服务如何实现。

- 软件架构视图：从宏观上描述HA服务内模块间关系。
	HA服务由三层组成：（从下到上）
	- **通信层**：提供与周边CSE、SDK的通信能力。
	- **通信代理层**：在代理层实现与周边服务具体的消息交互接口。
	- **业务层**：
		- **对象**：包含仲裁者、服务组、服务实例等对象管理。提供基础增删改查接口。
		- **HA仲裁**：基于HA对象数据，管理管理服务实例状态。
		- **对象管理**：负责对接CSE，将服务实例管理对象添加到本地，并同步状态到CSE。

![image.png](https://rnd-isourceb.huawei.com/images/XA/20190930/5e6535c5-c259-4140-955e-81a2d49ff839/image.png)

- 代码架构视图：从微观上描述HA服务内模块间交互。
![image.png](https://rnd-isourceb.huawei.com/images/XA/20190930/12c5481e-2481-45e1-b99d-d7a52e755cd3/image.png)


